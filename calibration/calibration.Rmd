---
title: "An open-source, open-data model for pedestrian movement at the finest possible scale"
author: "Mark Padgham"
output:
   #github_document
   #word_document: default
   # pdf_document:
   #     number_sections: yes
    html_document:
        toc: true
        toc_float: true
        number_sections: true
        theme: flatly
    header-includes: 
        - \usepackage{amsmath,sfmath}
        - \usepackage{tikz}
        - \usetikzlibrary{arrows}
bibliography: ../ATF.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
library(dplyr)
knitr::opts_chunk$set(
  echo = FALSE,
  out.width = "100%",
  collapse = TRUE,
  comment = "#>",
  fig.path="figures/"
)
if (!file.exists ("ATF.bib")) { # delete file to auto-update
    refs <- RefManageR::ReadZotero(group = "418217",
                    .params = list(collection = "TJEQMXJR", limit = 100))
    RefManageR::WriteBib(refs, "../ATF.bib")
}
library (ggplot2)
theme_set (theme_minimal ())
```


# Introduction

Pedestrian modelling is very generally approached as an *aggregate* phenomenon,
attempting either to directly model movement between variously aggregated areal
units, or to explain pedestrian counts in terms of explanatory variables
aggregated over defined--and often notably coarse--spatial areas [see, for
example, the comprehensive references in
@singleton_pedestrians_2013;@griswold_pedestrian_2018]. Moreover, pedestrian
models are frequently considered to be additional or even "optional"
components of general transport models, and have thus been constructed to be
backwards-compatible with traditional modelling approaches, notably through
focussing on coarse spatial scales of aggregation such as "transport analysis
zones" [@singleton_pedestrians_2013]. Progress is modelling pedestrian
behaviour has generally lagged notably behind progress in modelling other forms
of transport [@kuzmyak_estimating_2014], even though recent research has
suggested and revealed that pedestrian behaviour is more strong determined by
variations at finer spatial scales than other travel behaviour
[@clifton_representing_2016]. 

Parallel to the development of such arguably more "traditional" approaches to
modelling pedestrian behaviour has been the development of very fine-scale
agent-based simulations such as "Simulation of Urban Mobility" [SUMO;
@krajzewicz_recent_2012] and UrbanSim
[@waddell_urbansim:_2002;@waddell_integrated_2011]. These are other such tools
yield highly detailed models of dynamic pedestrian movement, yet are typically
constrained to small spatial extents, typically much less than entire city
extents. Current practices in modelling pedestrian movement are thus often
faced with a compromise between modelling movement with sufficient detail yet
only over restricted spatial extents, or modelling movement over larger spatial
extents yet with insufficient fine-scaled detail.

The present work takes advantage of modern high-performance software for
modelling and analysing dynamic movement through urban areas
[@padgham_dodgr:_2019] to derive a general framework for pedestrian modelling
at the finest possible spatial scale of individual street segments. The model
presented here is not an individual-based simulation model, rather it
incorporates the finest possible representation of the spatial structure of
a city, including all possible detail of the "way network" (see below for
terminological note), and of all available buildings. It is not a multi-modal
model, and does not explicitly consider pedestrian movement in any direct
relationship with other modes of travel, although it does implicitly do so by
considering movement to and from both locations of public transport, and
private parking facilities for both bicycles and automobiles.

Importantly, our model is based entirely on open-source software, much of
which was explicitly developed or modified for the present study, and on
exclusively open sources of data. We consider such openness of both software
and data as critically important to advance the science of pedestrian
modelling. The spaces of cities are one of the primary "common goods" shared
amongst urban humanity, and walking is--or ought to be considered--the primary
mode of engagement with such shared spaces. Accordingly, we see pedestrian
modelling as a common good best advanced through open source software based on
open data.

In order to demonstrate the spatially expansive capabilities of our software
and models, we present a model of pedestrian behaviour throughout the entirety
of New York City. The model is calibrated against pedestrian counts observed at
114 stations, using openly available data provided by the City of New York for
the year 2018. A major aim of the present work is to demonstrate a *general and
transferrable* technique for pedestrian modelling. Accordingly, our aim was not
just to model pedestrian flows throughout New York City, but to demonstrate how
the results may be directly transferred to other locations, through extracting
the general principles of the resultant model.

Finally, note that we refer to the network of traversable ways
within a city as a "way network", in contrast to arguably more traditional
terminology such as "street network." We do this in acknowledgement both of the
fact that many ways traversable to pedestrians can not be categorized as
streets (think of staircases, or paths across grass lawns), and that this is
the terminology adopted by our primary provider of open data, Open Street Map.


# Methods

Our model consisted of a number of "flow layers" between specified categories
of origin and destination locations. Each of these layers comprised flows
aggregated between every single pairwise combination of origin and destination
points, following quickest, or least-time, paths through the way network of New
York City as weighted for pedestrian routing.

## Data Sources

```{r ped-station-stats}
suppressPackageStartupMessages (requireNamespace ("sf"))
# just used to get the overall area of convex hull surrounding the stations
f <- "nycdot-bi-annual-pedestrian-index.zip"
if (!file.exists (f))
{
    u <- paste0 ("https://www1.nyc.gov/html/dot/downloads/misc/",
                 "nycdot-bi-annual-pedestrian-index.zip")
    check <- utils::download.file (url = u, destfile = f, quiet = TRUE)
}
utils::unzip (f, exdir = "./nyped")
files <- list.files (file.path (".", "nyped", "Shapefile"), full.names = TRUE)
f <- files [grep ("\\.shp", files)]

x <- sf::st_read (f, stringsAsFactors = FALSE, quiet = TRUE)
unlink ("./nyped", recursive = TRUE)
x <- sf::st_transform (x, 4326)
xdat <- x
xdat$geometry <- NULL
index <- grep ("\\_AM|\\_PM|\\_MD", names (xdat))
for (i in index)
{
    xdat [, i] [xdat [, i] == "-"] <- "0"
    xdat [, i] <- as.integer (gsub (",", "", xdat [, i]))
}
# average measures over the various count days, obtaining single estimates
# of pedestrian volumes within a 3-hour window
index <- grep ("\\_AM|\\_PM", names (xdat))
weekday <- round (rowSums (xdat [, index]) / length (index))
index <- grep ("\\_MD", names (xdat))
weekend <- round (rowSums (xdat [, index]) / length (index))

x <- sf::st_sf (borough = xdat$Borough,
                street = xdat$Street_Nam,
                from = xdat$From_Stree,
                to = xdat$To_Street,
                weekday = weekday,
                weekend = weekend,
                week = round ((5 * weekday + 2 * weekend) / 7),
                geometry = x$geometry,
                stringsAsFactors = FALSE)
xmp <- sf::st_cast (do.call (c, x$geometry), to = "MULTIPOINT") %>%
    sf::st_sfc (crs = 4326)
suppressMessages (
a <- round (as.numeric (sf::st_area (sf::st_convex_hull (xmp))) / 1e6)
)
```

The primary source of data for our models was Open Street Map (OSM), used to
obtain both a highly detailed representation of the way network, and of
building locations, structures, and purposes. We used the R software `osmdata`
[@Padgham2017] to download and process all OSM data. Data on pedestrian
densities was obtained from New York City Government's [pedestrian count
data](https://www1.nyc.gov/html/dot/html/about/datafeeds.shtml#Pedestrians),
collected bi-annually at `r nrow(x)` stations throughout the city, encompassing
a total area of `r a` km<sup>2</sup>. Additional data on subway usage was
obtained from the city's [Metropolitan Transit Authority
(MTA)](http://web.mta.info/nyct/facts/ridership/ridership_sub_annual.htm), with
data on locations of subway entrances obtained through the city's [open data
portal](https://data.cityofnewyork.us/Transportation/Subway-Stations/arq3-7z49).
The MTA figures are annual "ridership totals" for each station, which are
counts of number of passengers entering the system at each of 424 stations (or,
in a few cases, "station complexes", at which a single entrance provides access
to multiple proximate stations and multiple lines). There are no data for
system exits, and so we assumed that exit numbers equalled entrance numbers
throughout. The station locations given by the City of New York are single
coordinates for each station (473 in total). The City also provides coordinates
of all subway *entrances* (1,926 in total), along with associated subway lines
to which those entrances lead, with entrances often providing access to
multiple subway lines. We allocated the ridership data to subway entrances by
associating each entrance for a given line with the station coordinates for
that line, and associating each subway entrance with the nearest station for
that line. Entrances were associated with individual stations by repeating this
procedure for all subway lines, resulting in many entrances being associated
with both different subway lines and different stations, but nevertheless
providing an accurate connection between subway entrances, the stations to
which they lead, and the MTA's ridership counts. Counts for each station were
then distributed equally among all associated subway entrances, ultimately
converting 424 counts into 1,926 locations of associated pedestrian flows.





### The Street Network

Both the street network used to route pedestrian journeys, and the structure,
nature, and location of buildings serving as origins and/or destinations of
those journeys were obtained from Open Street Map, accessed via the R package,
`osmdata` [@Padgham2017]. The network consisted of 813,402 street
segments, representing a total 30,226 km. These segments are simply those used
to represent Open Street Map, such that a single linear length of way may be
represented by several points, and several corresponding edges in our internal
representation. We then used the `dodgr` software [@padgham_dodgr:_2019] to
"contract" this network down to segments between junctions points only,
reducing it to 407,840 segments.

Each of these 407,840 segments had an associated length, along with further
detail as contained in the Open Street Map data, including the type of way
(with such values as "cycleway", "footway", "pedestrian", or "steps"). These
types were used to weight the distances to reflect typical pedestrian
preferences [@luxen_real-time_2011], to enable pedestrian routes to be
accurately calculated. These weighting schemes act to extend the effective
length of ways unsuitable for pedestrians, for example, by multiplying actual
lengths of major vehicular roads by some factor representative of the
associated pedestrian discomfort in comparison to quiet, pedestrian-only ways.
All weighting factors are greater than one, so that the most
pedestrian-friendly ways retain their original distances, while ways less
suitable for pedestrian travel have weighted lengths greater than their actual
lengths. Routing is then conducted using these weighted lengths, and so routes
reflect those that would be typically chosen by pedestrians. Rather than
distance-based routing, we used time-based routing, which operates on a similar
principle, but introduces several categories of additional time-based
penalties, notably for waiting at traffic lights, or for waiting to cross busy,
multi-lane roads (where such crossing is permitted). All routing was
implemented using the authors' own `dodgr` software [@padgham_dodgr:_2019].

### Trip categories

Open Street Map includes not only streets, but also buildings with optional yet
frequently extensive descriptions of categories, purpose, sizes, and other
properties. These building descriptions enable Open Street Map to be used to
identify likely locations of trip origins and destinations according to trip
purpose. In particular, we divided building categories into the five main
groups of transportation, sustenance, entertainment, education, and healthcare,
each by grouping the Open Street Map tags given in Appendix 1. Transportation
notably included all parking facilities, both for bicycles and automobiles.

For each of these categories, we estimated local intensities of the respective
activities by attributing all buildings to the nearest street network junction,
and aggregating numbers at each junction. These numbers provided estimates of
likely numbers of people originating from or coming to that point for the
respective activities, and are referred to throughout the present work as
"densities." For transportation, Open Street Map data commonly include
capacities of parking facilities, whether for bicycles or automobiles. These
capacities were taken as the densities of points which provided them, while all
other points were assigned the average capacity of all functionally similar
points (so, for example, bicycle parking facilities absent specified capacity
were assigned the average capacity of all bicycle parking facilities with
specified capacities).

Beyond these Open Street Map-based estimates, we also used Worldpop data to
ascribe aggregate residential densities to each street junction, and subway
counts to represent journeys to or from entrances and exits of the New York MTA
subway system. A final category was based on the betweenness centrality of the
entire street network. Centrality is known to be a strong determinant of travel
behaviour, with more central points, or street segments, correlated with higher
densities of movements towards or away from those points or segments. A final
categorical trip purpose considered in our analyses below is thus,
"centrality".

Extraction and processing of these data enabled analyses of the eight
trip categories specified in the following table, serving as types of journey
origins or destinations. The table also enumerates numbers of buildings of each
category in the OSM database at the time of our analyses (around October 2019).

n | category | number of structures or points
--- | --- | ---
1 | subway | 1,926
2 | centrality | -
3 | residential | 99,022
4 | transportation | 6,691
5 | sustenance | 7,489
6 | entertainment | 459
7 | education | 1,680
8 | healthcare | 1,147

Each category of trip represented one pairwise combination of these eight
categories, yielding 8&#215;7 = 56 distinct categories. An additional eight
categories were formed through modelling random dispersal away from spatial
locations identified for each category.

## Modelling Pedestrian Flows

We calibrated our model of pedestrian flows throughout the entirety of New York
City, USA, against empirical data from the 114 pedestrian count stations. Flow
layers were generated in two primary ways: either by dispersing from a given
set of origin points according to specified densities, or through routing flows
between specific sets of origin and destination points, with densities
calculated by a doubly-constrained spatial interaction model, with exponential
form used throughout [@Wilson2008]. We refer to these two methods of
calculating flow layers as "flow dispersal" and "flow aggregation", and
illustrate both in the following sub-sections.

As described above, for all layers other than dispersal, shortest paths were
calculated between all pairwise combinations of origin and destination points,
and flows aggregated along each street segment throughout the entire network.
The shortest paths were actually calculated by weighting the network for
time-based pedestrian travel, and so were represented "quickest paths" between
each pair of points. The following sub-section briefly formalises our models.



### Flow Layers

Each flow layer was obtained through calculating shortest paths between each
origin point, $i$, and destination point, $j$, in the network, and aggregating
flows according to exponential spatial interaction models [@Wilson2008] of the
form,
\begin{equation}
    SI_{ij} (d_{ij}) = \frac{n_in_{j\ne i}}{\sum_{j\ne i} n_j exp (-d_{ij} / k)} exp (-d_{ij} / k),
\end{equation}
where $d_{ij}$ denotes the distance between the points $i$ and $j$ (and
self-flows $SI_{ii}$ were excluded), and $n_i$ denotes the number or densities
of individuals at origin point $i$. The denominator ensured that our models
were singly-constrained to unit sums for each origin, $i$, over densities at
destinations, $j$. The above form gives the expected flow, in direct units of
$n_i$, along the path between the points $i$ and $j$. Layers were also
calculated describing undirected dispersal throughout the entire network from
a set of origin points.

Our [`dodgr`](https://github.com/ATFutures/dodgr) software enables spatial
interaction models to be efficiently calculated for a range of exponential
decay coefficients, `k`, returning a matrix of flows, with one row for each
segment of the network, and one column for each exponential decay coefficient
entered (see the following sub-section on Computational Strategy). This enabled
us to initially calculate all flow layers for defined values of `k`, and to
subsequently combine these pre-calculated layers in a single model as described
in the following section. Each layer was calculated for 30 values of `k`, from
100 to 3000 metres in 100 metre increments.

The strength of spatial interaction (SI) given above was used to determine the
flow between each pair of origins and destinations in a given layer. The flow
along the path between any given pair was then equal to the SI value divided by
the length of the path. Such division has the important effect of ensuring that
the sum of flows throughout the entire network is equal to the sum of densities
at all origins for that layer, $\sum_i n_i$. This procedure is also equivalent
to presuming that the SI specifies a static property such as aggregate flows
per unit time, whereas the flow layer itself provides a dynamic or
probabilistic snapshot such that, for a flow of $F$ between two points, $i$ and
$j$, separated by $n$ edges, the flow along any one of those edges at any
instant of time will equal $F/n$ (Figure 1). 

```{tikz, flow-diagram, fig.ext = 'png', cache=FALSE, code=readLines("figures/fig1.tex"), fig.cap = "Figure 1. All panels depict unit flows from A to B (black lines in left panels) and from C to D (gray lines in left panels). Panel A shows the unnormalised unit flows from A to B, and from C to D; Panel B the direct aggregation of those values. Panel C shows the normalised flows such that the sums of flows from both A to B and C to D equal one; Panel D shows the aggregation of normalised flows. Sums of flows in B equal 5, while sums in D equal 2, the same as flows from the two origins. Our models were based on flows normalised and aggregated as depicted in Panel D."}
```


Finally, the city-wide flows from these flow layers, amounting in each layer to
values along over 800,000 street segments, were mapped on to the locations of
the pedestrian count stations. Flow layers contained non-zero values for
the actual street segments on which count stations were located only where the
data describing the start and end points translated into at least one route
passing along that segment. This was not always the case, and so values for
each pedestrian counter were aggregated from a selected number of nearest
non-zero flow values. This number itself was varied between 1 and 20, and the
value chosen which gave the minimal error model following the procedures in the
subsequent section. This approach yielded flow values at pedestrian count
stations which were aggregated over potentially differing numbers of nearest
street segments for the different layers, but we argue that this procedure is
appropriate because actual placements of flow values for each layer depend on
the spatial location and variability of data as recorded in Open Street Map.

### Computational Strategy

Calculating the flow layers was naturally  a very computationally demanding
endeavour. Our models aimed to discern for each layer an optimal width of
exponential spatial interaction yielding the lowest overall model error,
according to the modelling procedure described immediately below. To do that,
we needed to calculate each layer for a range of exponential widths ($k$).
Rather than independently calculating each layer for each value of $k$ for
potential incorporation within a final aggregate model, we pre-calculated all
layers for 30 distinct values of $k\in\{100,200,300, \ldots 3000\}$, using the
aforementioned ability of our `dodgr` software to calculate a single layer for
multiple values of $k$ at effectively no additional computational cost. As also
described above, we obtained flows at each pedestrian count station by
aggregating over some variable number of nearest edges, hereafter denoted $n$,
for which we used values between 1 and 20. This translated to each flow layer
providing 30 values of $k$ times 20 values of $n$, or 600 estimates. Each of
these 600 values was pre-calculated prior to assembling the final model as
described in the following section.

All computation was conducted on a standard laptop, with the pre-computation of
flow layers taking a few days total calculation time, a duration we consider
quite reasonable for effectively $64\times600\times O(1,000)^2\sim
50,000,000,000$ shortest path calculations on a network with around half
a million edges.


### Statistical Models

The 64 pairwise combinations of origin and destination categories represents 64
potential independent variables in a statistical model (times the two
additional variables described above of $k$ and $n$). Our final model
incorporated only a small fraction of this total number, through applying
a step-wise variable addition procedure. The first layer was selected by
calculating linear regressions against the 114 observed pedestrian flows for
each layer and all 600 combinations of $k$ and $n$, and selecting the layer and
corresponding values of $k$ and $n$ which yielded the lowest squared residual
error.

The procedure was then repeated by applying an analogous procedure to all 63
remaining layers, and including the flow values from the previously-selected
layer in a multiple linear regression model. Having selected the second layer,
it was then also included along with each of the remaining 62 layers, in order
to determine the third layer yielding the model with the lowest overall error.
Flow layers were successively added as long as their contribution to the model
was significant; that is, layer addition within the model was terminated as
soon as the next layer added made no significant contribution. Where the
addition of new layers rendered the contribution of any prior layers no longer
significant, those non-significant layers were removed from the model. We used
two degrees of significance to generate the results given below: initial model
construction used a significance of $p\le0.05$, while final models only
retained layers with $p\le0.01$. Removal of layers modifies resultant models,
including significance values, and so removal of layers with $0.01<p\le0.05$
was iterated until all remaining layers in the final model had $p\le0.01$. The
statistical summaries given below also include estimates of the relative
importance of each variable [@lindeman_introduction_1980], obtained by
decomposing components of model variance over all permutations of variable
orders [@gromping_relative_2006].

Finally, it is statistically possible for flow layers to be significantly
*negatively* correlated with observed counts (Figure 2). Because each layer was
formed from effectively arbitrary categories, and because there was no way of
knowing at the outset which categories may or may not be significantly related
to pedestrian behaviour, negative correlations must be expected. In the context
of Fig. 2, a negative correlation could only be avoided if the layers L1 and L2
were combined at the outset to generate a single composite layer. In general,
there can be no way of knowing in advance which combinations of layers might be
necessary to avoid negative correlations.

```{tikz, neg-cor, out.width="40%", fig.ext = 'png', cache=FALSE, code=readLines("figures/fig2.tex"), fig.cap = "Figure 2. Illustration of negative correlations, with flow from two layers (L1 and L2) to two points in the network (A and B) having the indicated values. If observed pedestrian counts at the points A and B were both equal to 1, the minimal-error combination of flow layers would be L1 - L2, and the latter would be negatively correlated."}
```



## Calibration to Observed Values

The observed pedestrian counts are given as total numbers observed
within either two- or three-hour windows (twice on weekdays, between
7-9am and 4-7pm; and once on Saturdays, between 12-2pm). We used the
weekday counts to yield an overall aggregate estimate of numbers per
day. To scale the observed values, we compared them with values derived
from the United Kingdomâ€™s National Travel Survey
([NTS](https://beta.ukdataservice.ac.uk/datacatalogue/series/series?id=2000037),
waves 2002-2017 representing 5.8m single stage journeys), from which we
obtained a nation-wide estimate of numbers of walking trips for each of the 24
hours of the day (see Figure 3).


```{r hourly-walking, fig.cap = "Figure 3: Hourly proportions of total daily walking trips as obtained from the UK's National Travel Survey, with shaded areas illustrating the hours of pedestrian counting start between 7-9am and 4-7pm"}
f <- "wh.csv"
if (!file.exists (f))
{
    u <- "https://github.com/ATFutures/ATF-ideas/releases/download/0.0.1/wh.csv"
    invisible (download.file (u = u, destfile = f))
}
x <- read.csv ("wh.csv")
x$hour <- as.integer (substring (x$hour, 1, 2))
ymax <- max (x$perc)
ggplot (x, aes (x = hour, y = perc)) +
    geom_rect (aes (xmin = 7, ymin = 0, xmax = 10, ymax = ymax),
               fill = "#66666605") +
    geom_rect (aes (xmin = 16, ymin = 0, xmax = 20, ymax = ymax),
               fill = "#66666605") +
    geom_line () +
    geom_point () +
    ylab ("hourly proportion of total daily walking trips")
```

```{r hourly-walking-stats, echo = FALSE}
index <- which (x$hour %in% c (7:9, 16:19))
walk_total <- signif (100 * sum (x$perc [index]), 3)
walk_prop <- signif (sum (x$perc [index]), 2)
walk_conversion <- signif (1 / sum (x$perc [index]), 3)
```


These data reflected a total proportion of trips between the hours of 7-9am and
4-7pm of `r walk_total`%. We assumed this figure to approximately reflect
global pedestrian behaviour, and so converted observed pedestrian counts -- as
the sum of the morning plus afternoon values -- to expected equivalent daily
totals for weekdays by multiplying by 1 / `r walk_prop` = `r walk_conversion`.

One of our motivating aims was to derive a model that could accurately predict
absolute pedestrian counts. Our final models were regression models, and so the
resultant estimates for each layer provided relative scaling coefficients for
those layers. Flow values for the layers themselves were determined by values
at the points of origin for each layer, such that the sum of flows for each
layer was equal to the sum of values for all origins in that layer (see Figure
1). 

```{r subway-stats, echo = FALSE}
# subway-stats is output of who3::nysubway_data()
subway <- readRDS ("./subway-stats.Rds")
```

The only layers with direct scales in numbers of pedestrians per day were those
representing movement away from subway exits. Presuming numbers exiting each
station to equal the recorded numbers entering each station, the total daily
count of `r format(sum(subway$count) / 356, big.mark = ",")` passengers
distributed over `r format(nrow(subway), big.mark = ",")` station exits gives
`r format(round(sum(subway$count)/365/nrow(subway)), big.mark = ",")`
pedestrians per station exit per day. Model estimates for layers originating at
station exits thus represent this number of pedestrians for each unit of
estimated coefficient. These estimates may of course be greater than one,
because, for example, the contribution to observed pedestrian counts of numbers
*effectively* dispersing from subway exits may in fact exceed the actual
numbers exiting, because this layer may in fact capture more pedestrian
activity than just dispersive movement of actual subway passengers.

Other layers result in more abstract scaling, but scales that are nevertheless
straightforward to interpret. Four of the categories are directly associated
with the location and form of built structures: sustenance, entertainment,
education, and healthcare. In each case, sizes of origins were aggregate
numbers of building of these categories associated with each junction of the
street network. The reason these categories were treated independently was
because each is generally associated with different scales -- healthcare
includes hospitals, which can be very large, and serve as origins and
destinations for large numbers of pedestrian journeys. Educational institutions
can be similarly large, but potentially cater for distinctly different social
groups. The category of sustenance includes restaurants and supermarkets (and
any categories in between), and so may vary markedly in effective size.
Entertainment may be similarly diverse, and was included as its own separate
category primarily because pedestrian movement to and from entertainment
centres is likely to occur at markedly different times of day (or night, as the
case may be) than movement in relation to the other categories and, even if
only through this difference alone, may manifest categorically distinct
patterns of movement.

Transportation was considered its own distinct category according to an
hypothesis that movement to or from transportation centres may capture
pedestrian behaviour in relation to both cycling and the driving of
automobiles. As described above, sizes of transportation sources were
quantified in numbers of parking places where given, with local averages
assigned to locations lacking specific capacities. Finally, centrality has its
own absolute scale equal to the square of the total number of distinct vertices
or points within a network. In our case, this was equal to the total number of
street junctions, which was 134,732. Centrality was simply rescaled to
a maximum of one, and was the only category to which an absolute scale could
not be assigned.

For all other categories, the results below give effective numbers of
pedestrians observed in the final model for each unit of the corresponding type
of origin; for example, $n$ pedestrians per restaurant or supermarket for the
sustenance category, or $n$ pedestrians per unit of parking capacity for
transportation. These scale of layers to absolute numbers of pedestrians form
a central part of the results that follow.



# Results

The flow layer which made the most significant initial contribution reflected
movement from subway stations towards network centrality. The model error as
a function of the 30 values of exponential decay coefficients is illustrated in
Figure 4, and was typical for most layers, manifesting a clear and distinctive
minimum at 600m.

```{r get-layer-data, echo = FALSE}
f <- file.path (here::here (), "calibration", "sub-cen-model.Rds")
dolayer <- !file.exists (f)
```


```{r layer-error-with-k-calc, eval = dolayer}
library (nyped)
data_dir <- "/data/data/moveability/nyc"
net <- readRDS (file.path (data_dir, "calibration", "net-sub-cen.Rds"))
p <- ped_osm_id (data_dir = data_dir, net = net, quiet = TRUE)
saveRDS (p, file = file.path (here::here (), "calibration", "p.Rds"))
dp <- dodgr::dodgr_dists (net, from = p$id)

# code from calibration::opt_fit_to_ped
fcols <- grep ("flow", names (net))
sorted_verts <- function (dmat)
{
    res <- array (NA, dim = dim (dmat))
    for (i in seq (nrow (dmat)))
    {
        res [i, ] <- colnames (dmat) [order (dmat [i, ])]
    }
    return (res)
}
dp_verts <- sorted_verts (dp)
# then convert that to equivalent indices into both .vx0 and .vx1 of net_f
index0 <- t (apply (dp_verts, 1, function (i) match (i, net$.vx0)))
index1 <- t (apply (dp_verts, 1, function (i) match (i, net$.vx1)))

flowmat <- as.matrix (net [, fcols])
n <- 5 # number of neighbours to aggregate
temp <- rcpp_match_flow_mats (flowmat, index0 - 1, index1 - 1, fcols - 1, n)
saveRDS (temp, file = f)
```
```{r layer-error-with-k, fig.cap = "Figure 4: Squared residual error of linear model against single flow layer for a range of values of k, the width of the exponential spatial interaction model."}
p <- readRDS (file.path (here::here (), "calibration", "p.Rds"))
temp <- readRDS (f)
ss <- apply (temp, 2, function (j) {
                 mod <- summary (lm (p$week ~ j))
                 sum (mod$residuals ^ 2) / 1e6  })
dat <- data.frame (k = 1:30 * 100, ss = ss)
x0 <- dat$k [which.min (dat$ss)]
y0 <- min (dat$ss)
ggplot (dat, aes (x = k, y = ss)) +
    geom_line () +
    geom_point (aes (x = x0, y = y0), cex = 3) +
    xlab ("k (metres)") +
    ylab ("Model error (in observed daily counts)")
```


Following the procedure described above of adding the next minimal error layer
that was significant, while removing any layers rendered non-significant
through the addition of subsequent layers, resulted in the final model
statistically summarised in Table 1, ordered by layer origins, and within each
of these groups in decreasing relative importance.

```{r final-model, echo = FALSE}
dat <- readRDS ("ped-model-final.Rds")
dat$ped_counts <- dat$ped_counts * 2.34
f_ <- dat$flowvars
mod <- lm (dat$ped_counts ~ f_)
mods <- summary (mod)
coeffs <- data.frame (mods$coefficients [2:nrow (mods$coefficients), ])
# for some reason, colnames do not transfer properly:
names (coeffs) <- colnames (mods$coefficients)
coeffs <- cbind ("Layer Name" = gsub ("f_", "", rownames (coeffs)),
                 coeffs)

# Relative importance of variables:
ri <- relaimpo::calc.relimp (mod)
ri <- slot (ri, "lmg")

# remove Std. Error from coeffs
coeffs <- coeffs [, which (!grepl ("Std", names (coeffs)))]
coeffs [["Rel. Importance"]] <- ri

coeffs$k <- dat$k # SI k-values

# Next line is critical, because the vertical lines are interpreted by markdown
# as table column breaks, which mucks the whole thing up!
names (coeffs) [grepl ("Pr", names (coeffs))] <- "Pr(>t)"
# order by origin, then by relative importances
coeffs$origin <- substr (coeffs$`Layer Name`, 1, 3)
names (coeffs) [which (names (coeffs) == "t value")] <- "t"
# get max rel. importance for each origin:
rimax <- dplyr::group_by (coeffs, origin) %>%
    dplyr::summarise (ri = max (`Rel. Importance`))
coeffs$rimax <- rimax$ri [match (coeffs$origin, rimax$origin)]
coeffs <- dplyr::arrange (coeffs, dplyr::desc (rimax),
                          dplyr::desc (`Rel. Importance`))
rownames (coeffs) <- NULL
coeffs$origin <- coeffs$rimax <- NULL
names (coeffs) [grepl ("^t", names (coeffs))] <- "t value"
knitr::kable (coeffs, digits = c (NA, 0, 1, 4, 3, 0), row.names = FALSE, caption = "Table 1. Statistical parameters of final model of pedestrian flows through New York City.")
```

This table reveals that layer origins were divided between the five categories
of subway, health, sustenance, entertainment, and education. Each of these
origin categories was combined with multiple destination layers, except for
health and entertainment, with in each case the combinations coming from two to
three positively-correlated layers, and one to two negatively-correlated
layers. The model was able to explain R<sup>2</sup> = 
`r signif (mods$r.squared, 3)` of the observed variation in pedestrian counts
across New York City. Converting the estimates of the resultant statistical
model into absolute scales of pedestrians per day and summing the result
yielded the model shown in Figure 5.

```{r final-model-plot, echo = FALSE}
dat <- readRDS ("ped-model-final.Rds")
mod <- lm (dat$p ~ dat$flowvars)
smod <- summary (mod)
estmat <- t (matrix (as.numeric (smod$coefficients [, 1] [-1]),
                     nrow = ncol (dat$flowvars), ncol = nrow (dat$flowvars)))
f <- rowSums (dat$flowvars * estmat)
# same as predict(lm(dat$p ~ dat$flowvars)), except for intercept factor
#f <-  as.numeric (predict(lm(dat$p ~ dat$flowvars)))
res <- data.frame (modelled = f,
                   observed = dat$ped_counts)
ggplot (res, aes (x = modelled, y = observed)) +
    geom_point () +
    geom_smooth (method = "lm")
```

The most important layers in the model by far were those describing movement
away from subway exits. Model estimates for these layers were all several tens,
indicating rough equivalent numbers of pedestrians of these values times 
`r format (nrow (subway), big.mark = ",")` pedestrians per day, so for example
the most important category of dispersal from subway exists equated to 
`r round (coeffs$Estimate [1])` $\times$
`r format (nrow (subway), big.mark = ",")` = 
`r format (round (nrow (subway) * coeffs$Estimate [1]), big.mark = ",")`
pedestrians per day. While this number may seem high, it is important to note
that it represents dispersive movement along all nearby ways, so that effective
pedestrians flows along any one way will generally be orders of magnitude less
than this value. The second most important group was represented by the single
layer of dispersive movement away from healthcare facilities, with a similar
absolute scale of 
`r format (round (coeffs$Estimate [coeffs[["Layer Name"]] =="hea-dis"]), big.mark = ",")` 
pedestrians per unit building per day. Layers representing movement to defined
categories---that is, non-dispersive layers---had estimates generally at least
an order of magnitude lower than layers representing dispersive movement.

Widths of exponential spatial interaction or dispersal models ($k$ values in
Table 1) differed between the different flow layers, from 400 metres for the
most significant layer of dispersal from subways, to the maximal value
considered of 3,000 metres for dispersal from health care facilities. (There
were also two values of 100 metres for movement from educational facilities to
locations of both transport and sustenance.) In terms of these exponential
widths, patterns of movement from subway stations depended on journey origins,
with dispersive movement being relatively short (400 metres), other movement
(towards transport and centrality) being over around 1,000 metres, and movement
towards health centres having an exponential width of 2.1 kilometres. Movement
from other locations resulted in more consistent $k$ values for the various
categories of destination, with movement from locations of sustenance described
by exponential widths of 1-2 kilometres; and movement from educational facilities
by widths of under one kilometre.

## Generalizing the Model

As described at the outset, a primary aim of our model was to extract general
principles of pedestrian modelling, through abstracting these results as much
as possible from the particularities of pedestrian behaviour in New York City.
To do so, we took the final aggregate model layer in its entirety, and
retrospectively examined correlations with component layers taken in isolation
or in combination. Models were only constructed from positive (non-zero) values
for individual and aggregate layers. The above table suggested primary layers
representing movement from subway stations, and from locations of health,
sustenance, and education. To generalise the model, we quantified dispersive
movement away from each of these categories, then followed the stepwise
selection procedure used to construct the main model of observed pedestrian
counts, yet here fitting sequences of layers to the overall aggregate layer of
flows along all street edges of New York City (of which there were
$n=408,920$).

```{r general-model}
dat <- readRDS ("/data/data/moveability/nyc/ped-model-general.Rds")
dat <- data.frame ("Layer Name" = rownames (dat),
                   "Estimate" = dat$Estimate,
                   "t value" = dat [[grep ("^t", names (dat))]],
                   #"Pr(>t)" = dat [[grep ("^Pr", names (dat))]],
                   k = dat$k,
                   "Rel. Importance" = dat [["Rel. Importance"]],
                   stringsAsFactors = FALSE)
#names (dat) [grepl ("Pr", names (dat))] <- "Pr(>t)"
names (dat) [grepl ("^t", names (dat))] <- "t value"
names (dat) [grepl ("^Rel", names (dat))] <- "Rel. Importance"
dat <- dat [order (dat [["Rel. Importance"]], decreasing = TRUE), ]
knitr::kable (dat, digits = c (NA, 0, 0, 0, 3), row.names = FALSE, caption = "Table 2. Statistical parameters of general model of pedestrian flows through New York City.")
```

This general model explained $R^2=$ 
`r signif (sum (dat [["Rel. Importance"]]), 3)` of the variation in non-zero
flow values across the entire city, with the Relative Importance values of
Table 2 giving the contributions of each of the four layers to that overall
coefficient. (All layers were entirely significant, with all $p$-values
effectively zero.) Modelling dispersal from subway stations accounted for 0.56
of the explained variable portion of 0.66, or around 84%. 
The second most influential component was dispersal from educational
facilities, which explained 0.077/0.662 = 11.6% of the total explained
variance. Dispersal widths were in both cases roughly commensurate with the
preceding values from the original model (Table 1), at 300 rather than 400
metres for dispersal from subway, and 100 metres for dispersal from educational
facilities. The remaining two layers of dispersal from sustenance and health
care facilities represented a combined proportion of less than 3%, and are not
considered further here.

Beyond the specificities of New York City, this generalisation suggests that
simply modelling dispersal from public transport facilities can account for the
large majority of pedestrian flows throughout a city. The above model estimates
translate to $22\times2,250 = 49,500$ pedestrians per day from each subway
exit. To reiterate the above: This is not to be interpreted to indicate that
50,000 pedestrians actually disperse directly from each subwqy exit, rather
that the major portion of the city's general patterns of movement can be best
explained by the diffiusion of this number of people from the general areas
surrounding each subway exit. Dispersal from educational facilities plays
a significant yet secondary role, with an estimate of 33,000 pedestrians from
each facility.

# Discussion

The model developed here was able to reproduce over 85% of the observed
variation in pedestrian counts at 114 stations encompassing a large portion of
New York City. Both this final model and the generalisation steps revealed
dispersal from subway stations to be by far the most significant contribution
to pedestrian flows. While the ability to explain such a large proportion of
the variance in pedestrian counts across such a large area (705 km<sup>2</sup>)
in one of the world's major cities is obviously an achievement in its own
right, we hope that the major result of this study is the ability to generalise
this model beyond locational particularities.

Both the specific and general results confirm prior work on the important
influence of public transport on pedestrian activity
[@zacharias_pedestrian_2001]. The dispersal radius of 300 metres accords very
well with many prior studies on transit-oriented development and pedestrian
"walksheds" [see @stojanovski_urban_2019, and references therein]. These
generalisations obviously need to be confirmed through repeating such studies
in other locations, yet offer an immediate entry point for cities lacking the
detailed kinds of monitoring data provided by New York City. Absent any
additional data whatsoever, the general model could be adapted to other cites
by devising a means to estimate relative numbers exiting from public transport
stops or stations [using proxies such as network centrality;
@derrible_network_2012; @jiang_station-based_2018]. Modelling pedestrian
dispersal from these stops or stations according to estimates of passenger
numbers could then provide an initial relative indication of pedestrian
densities throughout a city. A city with a single pedestrian count station
would then be able to convert that relative scale to an absolute scale; a city
with $n$ pedestrian count stations would be able to consider combinations of
different layers, with the general model developed here demonstrating how
a explaining the major portion of all pedestrian movement can be constructed
from very few layers indeed.

## Is our model over-fitted?

We now argue why we believe our model to be entirely statistical valid, in
spite of the fact that we calculated around 50 billion shortest paths through
the way network of New York City in order to correlate results with 114
observations. Numbers of independent variables were at most the 64 layers
considered times the 600 combinations of values of $k$ and $n$. As explained
above in reference to negative correlations, however, the actual layers
effectively contributing to observed pedestrian behaviour remain unknown even
after constructing our model, with negative correlations likely indicative of
some kind of mismatch between our arbitrary layer categories and actual
behaviour with regard to categorical origins and destinations. According to
this hypothesis, although we examined 64 layers, we ought to have expected
layers from common origins to be combined both positively and negatively to
reflect effective single layers, and thus this number of 64 layers can not be
interpreted to reflect 64 independent variables. Moreover, this number is less
than numbers of variables commonly employed in pedestrian models [see again
@singleton_pedestrians_2013;@griswold_pedestrian_2018, and references therein].

The combinations of 600 values of $k\times n$ similarly does not represent an
equivalent number of independent variables, as each layer was only ultimately
represented by one single value of each. The final model included 5 categories
of origin, with two of these represented by a single layer, and each of the
remaining three by four layers. This translates to an average of 2.8
destinations per origin. Presuming this to reflect some underlying general
process governing combination of layers would suggest an effective number of
independent layers of 64 / 2.8 = 23. Values of $k$ and $n$ would then represent
one additional variable each, amounting to 25 equivalent independent variables
or degrees of freedom used to explain 114 observations, suggesting an entirely
valid statistical procedure.

## Future Steps

There is obviously an immediate need to apply the procedure developed here to
other locations and other data. What we have nevertheless developed is
a procedure that is entirely amenable to universal adaptation, with very little
need to adapt or translate the modelling procedure for other locational
particularities. In that regard, we argue that our modelling procedure truly is
unique and uniquely powerful. Many or arguably most models of pedestrian
behaviour are drawn from highly specific data collected in, and relevant to,
one particular location. Even in cases where adapting such models to other
locations may be possible, such adaptation almost always requires expensive
data collection in order to replicate the data inputs of initial case studies.
Our model merely presumes that a location is reasonably well represented in
Open Street Map, and that pedestrian counts are available. Locations in which
the former requirement is not sufficiently well met can translate a desire to
develop an accurate pedestrian model into the more general, and vastly more
generally useful, task of enhancing their representation in the worlds foremost
open data base of urban structure.


# References
