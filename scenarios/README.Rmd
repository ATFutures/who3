---
output: github_document
# output: pdf_document
title: Scenarios for the urban planning and transport health assessment tool
bibliography:
  # /home/robin/uaf/allrefs.bib
  # - ../ATF.bib
  - references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
```

```{r refs, eval=FALSE}
# refs_cycle_hire = RefManageR::ReadZotero(group = "418217", .params = list(collection = "JAK5PW5K", limit = 100))
# refs_atf = RefManageR::ReadZotero(group = "418217", .params = list(collection = "TJEQMXJR", limit = 100))
# o = ls()
# r = o[grepl(pattern = "refs_", x = o)]
# refs = do.call(what = c, args = mget(r))
# ref_df = as.data.frame(refs)
# # View(ref_df)
# RefManageR::WriteBib(refs, "references.bib")
citr::tidy_bib_file(rmd_file = "scenarios/README.Rmd", messy_bibliography = "~/uaf/allrefs.bib", file = "scenarios/references.bib")
```

# Note

This is a draft document to discuss code and analysis that feeds into a final report.
It should not be seen as finished.
See https://atfutures.github.io/upthat/ for outputs.

# Introduction

This report documents deliverable 2, scenario developement, for the WHO UPTHAT project, which involves:
(1) setting out high level policy scenarios of active transport uptake; (2) converting these changes into estimates of rates of shift towards walking and cycling down to route network levels; and (3) simulating the impacts of these scenarios on walking and cycling levels citywide. Scenario development will also be strongly informed by the transport scenarios assessed in Accra and Kathmandu as part of UHI project activities.


# High level policy scenarios of active transport uptake

High level priorities are to improve population health, air quality and safety levels.
This means increasing the proportion of the population that gets regular physical activity, reducing motorized vehicle use in urban centres and providing walking and cycling routes that are away from or otherwise protected from motor traffic.
Urban transport policies can meet each of these objectives, creating 'win win win' options.
Reducing car use, for example, will directly improve air quality and indirectly improve health and safety levels.

Specific scenarios of change include:

- 'Get walking', referring to a global (meaning without spatial input components, but with spatially distributed consequences) walking uptake, as a result of citywide policies to promote safe and attractive walking.
- 'Get cycling', referring to a global scenario of cycling, as a result of citywide policies to provide safe cycleways.
- 'Car diet', a global, citywide scenario of multi-modal transport change, showing reduced levels of driving following disincentives to own and use cars.
- 'Go public transport', a global scenario of public transport uptake, linked to [SDG 11](https://sustainabledevelopment.un.org/sdg11).
- 'Car free', meaning investment in car free city centers and other spaces, other locally specific scenarios, such as reductions in car parking spaces.

# Citywide scenarios of change

To calculate scenarios of change, the minimum data requirements are the region's current modal split and data that can be used as explanatory variables, including data on transport infrastructure and car parking spaces, and data on the provision of public transport options.

## Mode split data

Mode split is one of the fundamental pieces of information that is known for most cities.
For context, it's useful to take a step back and consider the range of modal splits observed in a sample of cities worldwide.
The figure below shows the diversity in mode splits based on (primarily wealthy) cities, based on data of the type shown in the table below from [Wikipedia](https://en.wikipedia.org/wiki/Modal_share).

```{r}
dc = readRDS("../global-data/city-mode-split-wiki.Rds")
# dc = readRDS("global-data/city-mode-split-wiki.Rds")
dc %>% 
  filter(
    walking == max(walking) |
    cycling == max(cycling) |
    pt == max(pt) |
    car == max(car) |
    car == min(car) 
    ) %>% 
  knitr::kable()
```

The figure shows that cars dominate the transport systems of most cities, accounting for a mode shares ranging from 18% (Osaka, Japan) to 85% (Adalaide, Australia).
A more useful way to view travel systems from an active transport perspective is to view walking as the foundation of transport systems and all other modes to supplement walking.
This view is shown on the right of the figure, which shows walking mode shares in the sample of cities ranging from only 3% to more than 1/3rd (in Madrid, Spain and Vilnius, Lithuania).
It is interesting to note that while there is a roughly even distribution of mode shares by car, other modes have more skewed distributions.
This could reflect the diversity of policies used to promote walking, cycling and public transport and the fact that cars tend to be the default.
This implication is that **if no policies have been implemented to promote alternatives, cars dominate**.


```{r, fig.show='hold', out.width="100%"}
# see code/mode-split-cities.R
knitr::include_graphics("../figures/city-mode-split-wiki-cars.png")
knitr::include_graphics("../figures/city-mode-split-wiki.png")
```

The relationships between the different modes is illustrated in the figure below, which suggests competition between all modes and cars (with public transport seeming to be the biggest deterrent to driving in this dataset), and synergies between public transport and walking.
**This strongly suggests that a reliable way to encourage walking in cities is through investment in public transport.**

```{r, out.width="50%"}
knitr::include_graphics("../figures/city-mode-cor.png")
```

This city level data allows models of mode split to be developed, assuming there are sufficient explanatory variables defining the transport system.

## Transport system data

Transport systems are complex, composed of hundreds of interrelated elements.
For modelling purposes, it makes sense to condense available datasets down into a few key parameters per city, zone or origin-destination pair.
The process of identifying and quantifying transport system variables should be be an open-ended and adaptable process that is able to respond when the input data changes (e.g. due to changes in the transport system or improved data availability/collection).

This section therefore provides a framework for including key transport system variables, based on the assumption that additional/modified variables will be used in future iterations of the model.
Key variables that are readily available for most cities include:

- Percentage of the transport network that is dedicated to motor traffic (an alternative or suplementary measure could be the percentage of the city's surface area dedicated to motor traffic)
- Provision for public transport, in terms of the percentage of the city's area within walking distance (e.g. 300m) of public transport nodes such as bus stops and rail stations
- The percentage of the city's transport network that is dedicated to cycling. Other important variables include average gradient, type of cycle network, level or car ownership and directness of cycle routes compared with driving routes [@parkin_estimation_2008]. 
- Provision of walking infrastructure, for example the percentage of the city's transport network that is footway

Note that all the high level varibles outlined above are 'scale free', meaning that they do not depend on the city's size.
The scale free nature of such measures also means that they can be used to estimate mode shares not only at city levels but also at the level of 'desire lines' connecting origins and destinations, as with the use of average gradient as a predictor of cycling potential in the PCT [@lovelace_propensity_2017].
Some additional variables, such as distance and relative time/cost for alternative modes, only make sense when measured at the OD level.


## Modelling mode shift

Treating mode share as a dependent variable involves multiple interrelated dependent variables, which is problematic for standard regression approaches.
An alternative used in cycling potential research has been to 'expand' mode split data into individual categorical variables [@lovelace_propensity_2017, supplementary information].
This strategy is computationally intensive however.

# Methods of modelling mode shift at the city level

The datasets presented in the previous section are examples of proportional outcomes, where we are interested in the mode split of all travel in a city.
These types of data are common in ecological modelling [@douma_analysing_2019], which provided a basis for investigating the question of citywide scenarios of mode shift in which modes are analogous to species.
Dirichlet regression is a recently developed technique for modelling proportions based on a range of dependent variables [@maier_dirichletreg_2014].

Building on this work, support for Dirichlet regression was added to the R package `brms` [@burkner_brms_2017], which implements a Bayesian modelling framework based on the stan C++ library, in 2018.
The advantage of `brms` is that it estimates uncertainty, vital for effective 'no-regrets' policy making.
A basic example of the outputs of a Dirichlet regression model run are shown in the figure below, which represents the result of a model run for a subset of 28 cities for which we have access to population (other explanatory variables included provision of metro and bikeshare schemes).

```{r, eval=FALSE}
m = brm(mode ~ population + pt, data = d_min, family = dirichlet())
res = predict(m2, new_data)
```

```{r, out.width="50%", fig.show='hold'}
knitr::include_graphics(c("../figures/mode-share-prediction.png", "../figures/mode-share-prediction-metro.png"))
```

The result suggest that beyond a certain size, increasingly large city populations are associated with a lower proportion of trips made by driving in the sample of cities used.
More explanatory variables can be added using this framework, including categorical variables such as `has_metro`, the results of which (that increase the mode share by public transport and notably walking in the results, which also show confidence intervals) are shown.
Of course, the quality of the prediction relies on good input data predicting mode shift and relies on the assumption that cities are in equilibrium states.
**This strengthens the need for open data on mode shift at city, OD and local levels over time following a range of interventions.**

Results using different explanatory variables on a slightly larger dataset (n = 101) show the generalisability of the modelling framework.
The figure below shows more policy relevant explanatory variables: number of bus stops per inhabitant and the provision of a tram system, which is more viable in many cities than a metro system.

```{r, out.width="50%", fig.show='hold'}
knitr::include_graphics(c("../figures/mode-share-prediction-bus-stops-100.png", "../figures/mode-share-has-tram.png"))
```

The figure above shows the *marginal effect* of changes to one variable, holding all other variables equal.
**The model accounts for fixed effects such as population density that are hard to change with policy interventions.**
The relationship between population density and mode split is interesting in itself however, as shown in the figure below.

```{r, out.width="60%", fig.show='hold', fig.align='center'}
knitr::include_graphics(c("../figures/mode-share-prediction-density-100.png"))
```

Of course, we need more input data than the 101 cities taken from open data repositories shown above to reduce the confidence intervals.
However, we have clearly demonstrated a robust and highly flexible way to model mode shift that accounts for the interrelations between different transport modes.
The next step is to apply these models to real city datasets.

# Estimates of rates of shift towards walking and cycling down to route network levels

Taking Accra as an example, let's see how the modelling framework can estimate mode shift (remember this is based on a small input dataset and a proof of concept rather than final results).

```{r, eval=FALSE}
m = readRDS("model-result-brms-density-bus-stops-101.Rds")
class(m)
accra = cities %>% filter(City == "Accra") %>% 
  mutate(Density = Population / Area) %>% 
  select(Density, bus_stops_per_1000, has_tram, -geometry)
knitr::kable(accra)
```

|City  | Density| bus_stops_per_1000|has_tram |
|:-----|-------:|------------------:|:--------|
|Accra | 4787.81|            1.23008|FALSE    |


The current mode split can be estimated as follows:

```{r, eval=FALSE}
mode_share_current_estimate = predict(m, accra)[, , ]
knitr::kable(mode_share_current_est, digits = 2)
```

|          | walking| cycling|   pt|  car| other|
|:---------|-------:|-------:|----:|----:|-----:|
|Estimate  |    0.14|    0.05| 0.18| 0.59|  0.04|
|Est.Error |    0.11|    0.07| 0.13| 0.16|  0.07|
|Q2.5      |    0.01|    0.00| 0.01| 0.27|  0.00|
|Q97.5     |    0.43|    0.25| 0.48| 0.88|  0.24|

In the PT scenario, we can increase the provision of buses to 10 per 1000 people, representing a high level of provision within the range of the sample of cities worldwide:

```{r, eval=FALSE}
summary(cities$bus_stops_per_1000)
accra_pt = accra %>% mutate(bus_stops_per_1000 = 3)
mode_share_pt_estimate = predict(m, accra_pt)[, , ]
knitr::kable(mode_share_pt_estimate, digits = 2)
knitr::kable((mode_share_pt_estimate - mode_share_current_estimate)*100, digits = 1)
```

**Estimated change in mode share (percentage points)**

|          | walking| cycling|  pt|  car| other|
|:---------|-------:|-------:|---:|----:|-----:|
|Estimate  |     0.8|     0.5| 1.1| -1.9|  -0.5|


Under this scenario, the central estimate of car use drops by 12 percentage points while the central estimates for walking and cycling grow, by 2 percentage points and 4 percentage points, respectively.
This highlights the synergies between active transport modes and bus use implicit in the data, **suggesting that a combination of strong investment in public transport and active transport infrastructure can be complimentary.**
As mentioned already, larger input datasets, in particular with more example datasets from Africa and the developing world in general in this context, are needed to reduce the large confidence intervals around these estimates.

The framework enables us to model changes in mode share that would result from changes in any variable, categorical or continuous, 




- 'Get walking', referring to a global (meaning without spatial input components, but with spatially distributed consequences) walking uptake, as a result of citywide policies to promote safe and attractive walking.
- 'Get cycling', referring to a global scenario of cycling, as a result of citywide policies to provide safe cycleways.
- 'Car diet', a global, citywide scenario of multi-modal transport change, showing reduced levels of driving following disincentives to own and use cars.
- 'Go public transport', a global scenario of public transport uptake, linked to [SDG 11](https://sustainabledevelopment.un.org/sdg11).
- 'Car free', meaning investment in car free city centers and other spaces, other locally specific scenarios, such as reductions in car parking spaces.

# Converting the results to locally meaningful outputs

Scenario development accounting for the transport systems in Accra and Kathmandu, as part of UHI project activities, must be based on current transport data.
An overview for Ghana (a proxy for the travel pattern in Accra) is shown below.

```{r modes-ghana, out.width="50%", fig.show='hold'}
knitr::include_graphics("../figures/modes-ghana-work.png")
knitr::include_graphics("../figures/modes-ghana-work-simple.png")
```

# References